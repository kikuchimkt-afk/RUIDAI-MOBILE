import { GoogleGenerativeAI } from "@google/generative-ai";

const STORAGE_KEY = "ruidai_api_key";
const MODEL_STORAGE_KEY = "ruidai_model";

// State
let apiKey = localStorage.getItem(STORAGE_KEY) || "";
let selectedImages = []; // Array of Base64 strings

// Helper for safe JSON parse
function safeJsonParse(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    console.error(`Error parsing ${key}:`, e);
    return fallback;
  }
}

// DOM Elements
let app = {};

// Initialize
function init() {

  app = {
    dropZone: document.getElementById("dropZone"),
    fileInput: document.getElementById("fileInput"),
    uploadBtn: document.getElementById("uploadBtn"),
    previewArea: document.getElementById("previewArea"),
    generateBtn: document.getElementById("generateBtn"),
    questionCount: document.getElementById("questionCount"),
    modelSelect: document.getElementById("modelSelect"),
    customInstructions: document.getElementById("customInstructions"),
    printDate: document.getElementById("printDate"),
    studentName: document.getElementById("studentName"),
    instructorName: document.getElementById("instructorName"),
    resultSection: document.getElementById("resultSection"),
    resultContent: document.getElementById("resultContent"),

    // Modal
    apiKeyModal: document.getElementById("apiKeyModal"),
    apiKeyInput: document.getElementById("apiKeyInput"),
    saveApiKeyBtn: document.getElementById("saveApiKeyBtn"),
    settingsBtn: document.getElementById("settingsBtn"),
    toggleApiKey: document.getElementById("toggleApiKey"),
    printProblemBtn: document.getElementById("printProblemBtn"),
    printSolutionBtn: document.getElementById("printSolutionBtn"),
    printFullBtn: document.getElementById("printFullBtn"),
    printInstructorBtn: document.getElementById("printInstructorBtn"),
    progressContainer: document.getElementById("progressContainer"),
  };

  // Check for missing elements
  for (const [key, element] of Object.entries(app)) {
    if (!element) {
      console.error(`Missing DOM element: ${key}`);
    }
  }

  if (!apiKey) {
    showModal();
  } else {
    app.apiKeyInput.value = apiKey;
  }

  // Restore model selection
  const savedModel = localStorage.getItem(MODEL_STORAGE_KEY);
  if (savedModel) {
    app.modelSelect.value = savedModel;
  }

  // Restore persisted inputs
  const savedDate = localStorage.getItem("ruidai_print_date");
  if (savedDate) app.printDate.value = savedDate;

  const savedStudent = localStorage.getItem("ruidai_current_student");
  if (savedStudent) app.studentName.value = savedStudent;

  const savedInstructor = localStorage.getItem("ruidai_current_instructor");
  if (savedInstructor) app.instructorName.value = savedInstructor;

  updateGenerateButtonText();

  setupEventListeners();
}

function showModal() {
  app.apiKeyModal.classList.add("active");
  app.apiKeyInput.focus();
}

function hideModal() {
  app.apiKeyModal.classList.remove("active");
}

function setupEventListeners() {
  // Model Selection
  app.modelSelect.addEventListener("change", () => {
    localStorage.setItem(MODEL_STORAGE_KEY, app.modelSelect.value);
    updateGenerateButtonText();
  });

  // API Key Management
  app.saveApiKeyBtn.addEventListener("click", () => {
    const key = app.apiKeyInput.value.trim();
    if (key) {
      apiKey = key;
      localStorage.setItem(STORAGE_KEY, apiKey);
      hideModal();
    }
  });

  app.settingsBtn.addEventListener("click", showModal);

  app.toggleApiKey.addEventListener("click", () => {
    app.apiKeyInput.type = app.apiKeyInput.type === "password" ? "text" : "password";
  });

  // Persist Inputs
  app.printDate.addEventListener("input", () => localStorage.setItem("ruidai_print_date", app.printDate.value));
  app.studentName.addEventListener("input", () => localStorage.setItem("ruidai_current_student", app.studentName.value));
  app.instructorName.addEventListener("input", () => localStorage.setItem("ruidai_current_instructor", app.instructorName.value));

  // File Upload
  app.uploadBtn.addEventListener("click", () => app.fileInput.click());

  app.fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

  // Drag & Drop
  app.dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    app.dropZone.classList.add("dragover");
  });

  app.dropZone.addEventListener("dragleave", () => {
    app.dropZone.classList.remove("dragover");
  });

  app.dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    app.dropZone.classList.remove("dragover");
    handleFiles(e.dataTransfer.files);
  });

  // Paste
  document.addEventListener("paste", (e) => {
    try {
      const clipboard = e.clipboardData || window.clipboardData;
      if (!clipboard) return;

      const items = clipboard.items;
      const files = [];

      // Try getting files from items (preferred)
      if (items) {
        for (let i = 0; i < items.length; i++) {
          if (items[i].kind === 'file' || items[i].type.indexOf("image") !== -1) {
            const blob = items[i].getAsFile();
            if (blob) files.push(blob);
          }
        }
      }

      // Fallback: Try getting files directly
      if (files.length === 0 && clipboard.files && clipboard.files.length > 0) {
        for (let i = 0; i < clipboard.files.length; i++) {
          if (clipboard.files[i].type.indexOf("image") !== -1) {
            files.push(clipboard.files[i]);
          }
        }
      }

      if (files.length > 0) {
        e.preventDefault();
        handleFiles(files);
      }
    } catch (err) {
      console.error("Paste error:", err);
    }
  });



  // Generation
  app.generateBtn.addEventListener("click", generateSimilarProblems);

  // Preset Management
  loadUserPresets();
  setupPresetListeners();

  // Add Preset Button
  document.getElementById('addPresetBtn').addEventListener('click', addUserPreset);
  document.getElementById('newPresetInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addUserPreset();
  });

  // Name History Management
  setupNameHistory('studentName', 'studentNameList', 'ruidai_student_names');
  setupNameHistory('instructorName', 'instructorNameList', 'ruidai_instructor_names');
}

// --- History Dropdown Logic for Names ---
function setupNameHistory(inputId, listId, storageKey) {
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);
  const history = safeJsonParse(storageKey, []);

  // Helper to render
  const renderList = () => {
    list.innerHTML = '';
    const currentHist = safeJsonParse(storageKey, []);

    if (currentHist.length === 0) {
      list.classList.add('hidden');
      return;
    }

    currentHist.forEach((item, index) => {
      const li = document.createElement('li');
      li.className = 'dropdown-item';
      li.innerHTML = `
        <span class="content">${item}</span>
        <span class="delete-btn" title="ÂâäÈô§">√ó</span>
      `;

      // Select item
      li.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('delete-btn')) return;
        input.value = item;
        list.classList.add('hidden');
      });

      // Delete item
      li.querySelector('.delete-btn').addEventListener('mousedown', (e) => {
        e.stopPropagation(); // Prevent selection
        if (confirm(`${item} „ÇíÂ±•Ê≠¥„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
          const newHist = safeJsonParse(storageKey, []);
          newHist.splice(index, 1);
          localStorage.setItem(storageKey, JSON.stringify(newHist));
          renderList();
          // Keep list open or check if empty
          if (newHist.length === 0) list.classList.add('hidden');
        }
      });

      list.appendChild(li);
    });
  };

  // Show on focus
  input.addEventListener('focus', () => {
    renderList();
    if (list.children.length > 0) list.classList.remove('hidden');
  });

  // Hide on blur (delayed to allow click)
  input.addEventListener('blur', () => {
    setTimeout(() => {
      list.classList.add('hidden');
    }, 200);
  });

  // Save on change (optional, or just rely on global generate save)
  input.addEventListener('change', () => {
    // Optionally save immediately, but user requested "remember entered things".
    // We will save in generateSimilarProblems to ensure only used values are saved.
  });
}

function saveToHistory(inputId, storageKey) {
  const val = document.getElementById(inputId).value.trim();
  if (!val) return;

  const history = JSON.parse(localStorage.getItem(storageKey) || "[]");
  // Remove if exists to push to top
  const existingIdx = history.indexOf(val);
  if (existingIdx !== -1) history.splice(existingIdx, 1);

  history.unshift(val); // Add to top
  // Limit size? e.g. 10
  if (history.length > 10) history.pop();

  localStorage.setItem(storageKey, JSON.stringify(history));
}


const PRESET_STORAGE_KEY = "ruidai_custom_presets";
let userPresets = safeJsonParse(PRESET_STORAGE_KEY, []);

function loadUserPresets() {
  const container = document.getElementById('userPresets');
  container.innerHTML = '';
  userPresets.forEach((text, index) => {
    createPresetButton(text, index, container);
  });
}

function createPresetButton(text, index, container) {
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'preset-btn';
  btn.dataset.preset = text;
  btn.innerHTML = `${text} <span class="remove-tag" data-index="${index}" title="ÂâäÈô§">√ó</span>`;

  // Toggle selection
  btn.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-tag')) return; // Ignore click on remove
    btn.classList.toggle('active');
    updateCustomInstructionsPlaceholder(); // Optional visual feedback
  });

  // Remove handler
  btn.querySelector('.remove-tag').addEventListener('click', (e) => {
    e.stopPropagation();
    removeUserPreset(index);
  });

  container.appendChild(btn);
}

function addUserPreset() {
  const input = document.getElementById('newPresetInput');
  const text = input.value.trim();
  if (!text) return;

  // Prevent duplicates
  if (userPresets.includes(text)) {
    alert("„Åì„ÅÆ„Çø„Ç∞„ÅØÊó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åô");
    return;
  }

  userPresets.push(text);
  saveUserPresets();
  loadUserPresets(); // Reload to render
  input.value = '';
}

function removeUserPreset(index) {
  if (confirm("„Åì„ÅÆ„Çø„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
    userPresets.splice(index, 1);
    saveUserPresets();
    loadUserPresets();
  }
}

function saveUserPresets() {
  localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(userPresets));
}

function setupPresetListeners() {
  // Default presets logic (toggle instead of radio)
  const defaultContainer = document.getElementById('defaultPresets');
  defaultContainer.querySelectorAll('.preset-btn').forEach(btn => {
    // Clone to remove old listeners if re-running (not needed here but good practice)
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
    });
  });

  // Print Buttons
  app.printProblemBtn.addEventListener("click", () => openPrintPreview('problem'));
  app.printSolutionBtn.addEventListener("click", () => openPrintPreview('solution'));
  app.printFullBtn.addEventListener("click", () => openPrintPreview('full'));
  app.printInstructorBtn.addEventListener("click", () => openPrintPreview('instructor'));
}

// function setupPresetListeners() {...}

// Duplicate state removed from here.

function handleFiles(files) {
  if (files.length === 0) return;

  const validFiles = Array.from(files).filter(file => file.type.startsWith("image/"));

  if (validFiles.length === 0) {
    alert("ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
    return;
  }

  // Process all files
  let processedCount = 0;

  validFiles.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      selectedImages.push(e.target.result);
      processedCount++;

      if (processedCount === validFiles.length) {
        renderPreviews();
        app.fileInput.value = ""; // Reset input
      }
    };
    reader.readAsDataURL(file);
  });
}

function renderPreviews() {
  const container = app.previewArea;
  container.innerHTML = '';

  if (selectedImages.length === 0) {
    container.classList.add('hidden');
    app.uploadBtn.textContent = "ÁîªÂÉè„ÇíÈÅ∏Êäû"; // Reset text
    app.generateBtn.disabled = true; // Disable generate if no images
    return;
  }

  container.classList.remove('hidden');
  // keep dropZone visible to allow adding more
  app.uploadBtn.textContent = "„Åï„Çâ„Å´„Éö„Éº„Ç∏„ÇíËøΩÂä†";
  app.generateBtn.disabled = false; // Enable generate if images are present

  selectedImages.forEach((imgSrc, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';
    div.innerHTML = `
      <img src="${imgSrc}" alt="Page ${index + 1}" />
      <span class="page-number">P.${index + 1}</span>
      <button class="remove-btn" data-index="${index}" title="ÂâäÈô§">√ó</button>
    `;

    // Delete handler
    div.querySelector('.remove-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      removeImage(index);
    });

    container.appendChild(div);
  });
}

function removeImage(index) {
  if (confirm(`P.${index + 1} „ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
    selectedImages.splice(index, 1);
    renderPreviews();
  }
}

function clearImage() {
  // Legacy support or clear all
  if (selectedImages.length > 0 && confirm("„Åô„Åπ„Å¶„ÅÆÁîªÂÉè„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
    selectedImages = [];
    renderPreviews();
  }
  app.resultSection.classList.add("hidden");
}

async function generateSimilarProblems() {
  if (!apiKey) {
    showModal();
    return;
  }

  setLoading(true);

  try {
    const genAI = new GoogleGenerativeAI(apiKey.trim());
    const modelName = app.modelSelect.value;
    const model = genAI.getGenerativeModel({ model: modelName });

    // Prepare image parts
    const imageParts = selectedImages.map(imgData => ({
      inlineData: {
        data: imgData.split(',')[1],
        mimeType: "image/jpeg",
      },
    }));

    const count = app.questionCount.value;

    // Gather instructions from active presets + textarea
    const activePresets = Array.from(document.querySelectorAll('.preset-btn.active'))
      .map(btn => btn.dataset.preset)
      .join('\n');
    const customText = app.customInstructions.value;
    const instructions = `${activePresets}\n${customText}`.trim();

    // Save names to history
    saveToHistory('studentName', 'ruidai_student_names');
    saveToHistory('instructorName', 'ruidai_instructor_names');

    const prompt = `
# System Role
You are an expert tutor preparing supplementary materials.

# Task
Create ${count} similar problems based on the provided image.
The output must be a self-contained HTML document suitable for printing.

# Requirements
1. **Target Audience**: Same academic level as the problem in the image.
2. **Topic**: Exactly the same mathematical/scientific concept.
3. **Format**: OUTPUT RAW HTML ONLY. No markdown delimiters.
4. **Math Notation**:
    - DO NOT use LaTeX delimiters ($ or \[ \]).
    - Use standard HTML tags for variables (e.g., <i>x</i>, <i>y</i>).
    - **Fractions**: Use a vertical fraction layout with the following HTML structure:
      \`<span class="fraction"><span class="num">numerator</span><span class="den">denominator</span></span>\`
    - **Square Roots**: Use the following HTML structure:
      \`<span class="sqrt"><span class="radical">&radic;</span><span class="radicand">content</span></span>\`
    - Do NOT use slanted fractions like \`a/5\` or \`<sup>a</sup>/<sub>5</sub>\`.

# Custom Instructions
${instructions}

# HTML Structure
The output HTML must contain exactly three main sections within the body:

1. \`<div class="problems">...</div>\`
   - Contains the ${count} problems.
   - Each problem inside a \`<div class="problem-item">...</div>\`.

2. \`<div class="solutions">...</div>\`
   - Contains the solutions corresponding to the problems.
   - Separate from problems.

3. \`<div class="instructor-guide">...</div>\`
   - **MUST** be included.
   - Contains:
     - \`<h2>‰ΩúÂïèÊÑèÂõ≥„Å®Âà∞ÈÅîÁõÆÊ®ô</h2>\`: Bullet points explaining why these problems were chosen and what the student should learn.
     - \`<h2>ÊåáÂ∞é„ÅÆ„Éù„Ç§„É≥„Éà</h2>\`: Specific advice for teaching these concepts (e.g., common pitfalls, key steps).
     - \`<h2>Ëß£Ë™¨„ÅÆÈ†ÜÂ∫è„Éª„Éï„É≠„Éº</h2>\`: Recommended step-by-step explanation flow for the instructor.
     - Content should be professional, encouraging, and helpful for a tutor.


    const result = await model.generateContent([prompt, ...imageParts]);
    const response = await result.response;
    const text = response.text();

    // Clean up markdown code blocks if present
    const cleanHtml = text.replace(/```html| ```/g, "");

    app.resultContent.innerHTML = cleanHtml;
    app.resultSection.classList.remove("hidden");

    // Smooth scroll
    app.resultSection.scrollIntoView({ behavior: 'smooth' });

  } catch (error) {
    console.error(error);
    alert(`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${ error.message } `);
  } finally {
    setLoading(false);
  }
}

function updateGenerateButtonText() {
  const modelLabel = app.modelSelect.options[app.modelSelect.selectedIndex].text;
  const text = app.generateBtn.querySelector(".btn-text");
  text.textContent = `È°ûÈ°å„Çí‰ΩúÊàê(${ modelLabel })`;
}

function setLoading(isLoading) {
  const btn = app.generateBtn;
  const spinner = btn.querySelector(".spinner");
  const text = btn.querySelector(".btn-text");
  const progress = app.progressContainer;

  if (isLoading) {
    btn.disabled = true;
    spinner.classList.remove("hidden");
    text.textContent = "‰ΩúÊàê‰∏≠...";
    progress.classList.remove("hidden"); // Show progress bar
  } else {
    btn.disabled = false;
    spinner.classList.add("hidden");
    updateGenerateButtonText();
    progress.classList.add("hidden"); // Hide progress bar
  }
}

function openPrintPreview(mode) {
  const content = app.resultContent.innerHTML;
  const win = window.open("", "_blank");

  // Get header info
  const printDate = app.printDate.value || '';
  const studentName = app.studentName.value || '';
  const instructorName = app.instructorName.value || '';

  // Format date
  let formattedDate = '';
  if (printDate) {
    const d = new Date(printDate);
    formattedDate = `${ d.getFullYear() }Âπ¥${ d.getMonth() + 1 }Êúà${ d.getDate() } Êó•`;
  }

  // Build header HTML
  const headerHtml = `
      < div class="print-header" >
      <div class="header-left">
        ${formattedDate ? `<span class="date">${formattedDate}</span>` : ''}
        <div class="names">
            ${studentName ? `<span class="student">ÁîüÂæí: ${studentName}</span>` : ''}
            ${instructorName ? `<span class="instructor">Ë¨õÂ∏´: ${instructorName}</span>` : ''}
        </div>
      </div>
      
      <div class="header-right">
        <div class="score-box">
             <div class="score-item">ÁõÆÊ®ôÊôÇÈñì<div class="score-line"></div>ÂàÜ</div>
             <div class="score-item">ÂæóÁÇπ<div class="score-line"></div>/100</div>
        </div>
      </div>
    </div >
      `;

  let customStyles = "";
  let jsScript = "";

  // Enhanced Friendly Design Styles
  const friendlyCss = `
    @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');

    body {
      font - family: 'Zen Maru Gothic', sans - serif;
      color: #333;
      padding: 20px;
      line - height: 1.6;
    }

    /* Header Design */
    .print - header {
      display: flex;
      justify - content: space - between;
      align - items: flex - end; /* Align bottom for clean look */
      margin - bottom: 10px;
      border - bottom: 2px solid #333;
      padding - bottom: 5px;
    }

    .header - left.date {
      font - weight: 500;
    }

    .header - right {
      text - align: right;
      display: flex;
      gap: 15px;
    }

    .header - right h1 {
      margin: 0;
      font - size: 24px;
      letter - spacing: 2px;
    }

    /* Score Box */
    .score - box {
      border: 2px solid #333;
      border - radius: 8px; /* Slightly rounded */
      padding: 5px 15px;
      display: flex;
      gap: 20px;
      background: #fff; /* Ensure white background */
    }
    
    .score - item {
      font - size: 14px;
      display: flex;
      align - items: flex - end;
    }

    .score - line {
      border - bottom: 1px solid #333;
      width: 60px;
      margin - left: 5px;
    }

    /* Problem Layout */
    .problems, .solutions {
      display: grid;
      grid - template - columns: 1fr 1fr; /* 2 columns standard */
      gap: 20px;
    }

    /* Single column for solutions mode if needed, or dynamic */
    /* .problems.single-col { grid-template-columns: 1fr; } */

    .problem - item {
      border: 2px dashed #bbb; /* Friendly dashed border */
      border - radius: 12px; /* Soft corners */
      padding: 15px;
      background - color: #fff;
      page -break-inside: avoid;
      position: relative;
    }

    /* Numbering badge */
    .problem - item::before {
      /* content: ''; Numbering handled by content or counters? 
         Let's rely on content for now, or add a counter if requested. */
    }

    h1 {
      font - size: 1.4rem;
      margin: 10px 0 15px;
      border - left: 6px solid #666; /* Monochrome accent */
      padding - left: 10px;
      color: #333;
    }
    
    .page -break { page -break-after: always; }

    /* Mode Specifics */
    `;

  // Common fraction styles (Legacy/Backup)
  const fractionCss = `
      .fraction { display: inline - flex; flex - direction: column; vertical - align: middle; font - size: 0.9em; text - align: center; }
    .num { border - bottom: 1px solid black; padding: 0 2px; display: block; }
    .den { padding: 0 2px; display: block; }
    .print - header { display: flex; justify - content: space - between; margin - bottom: 1rem; font - size: 0.9rem; color: #555; }
    .header - right { display: flex; gap: 1.5rem; }
    `;

  // Common fraction and math styles
  const mathCss = `
      .fraction { display: inline - flex; flex - direction: column; vertical - align: middle; font - size: 0.9em; text - align: center; margin: 0 2px; }
    .num { border - bottom: 1px solid #333; padding: 0 2px; display: block; }
    .den { padding: 0 2px; display: block; }

    .sqrt { display: inline - flex; align - items: baseline; margin: 0 2px; }
    .radical { font - size: 1.2em; margin - right: 0px; line - height: 1; }
    .radicand { border - top: 1px solid #333; padding - top: 2px; padding - left: 1px; display: inline - block; line - height: 1.1; }
    `;

  if (mode === 'problem') {
    customStyles = `
      ${ friendlyCss }
      .solutions, .instructor - guide { display: none; }
      /* Ensure fit if necessary, but grid usually flows well */
      ${ mathCss }
    `;
    // No auto-scaling - user controls via print dialog
    jsScript = ``;
  } else if (mode === 'solution') {
    customStyles = `
      ${ friendlyCss }
      .problems, .instructor - guide { display: none; }
      h1 { display: none; } /* Hide main title if redundant */
      .page -break { display: none; }
      ${ mathCss }
    `;
    // Auto-fit JS for solution (no auto-print)
    jsScript = `
      < script >
      window.onload = function() {
        const container = document.body;
        let fontSize = 16;
        while (container.scrollHeight > container.clientHeight && fontSize > 8) {
          fontSize -= 0.5;
          document.body.style.fontSize = fontSize + 'px';
        }
      }
      </script >
      `;
  } else if (mode === 'instructor') {
    customStyles = `
      ${ friendlyCss }
      .problems, .solutions { display: none; }
      .instructor - guide { display: block; page -break-inside: avoid; }
      .instructor - guide h2 {
      border - left: 6px solid #4f46e5;
      padding - left: 10px;
      margin - top: 20px;
      color: #333;
    }
      .instructor - guide ul, .instructor - guide ol {
      margin - left: 20px;
      line - height: 1.8;
    }
      h1 { text - align: center; margin - bottom: 2rem; }
      ${ mathCss }
    `;
    jsScript = ``;
  } else {
    customStyles = `
      ${ friendlyCss }
      ${ mathCss }
      .instructor - guide { display: none; }
    `;
    // Full mode - no auto-print, let user click button
    jsScript = ``;
  }

  win.document.write(`
      < !DOCTYPE html >
        <html>
          <head>
            <title>È°ûÈ°å„Éó„É™„É≥„Éà</title>
            <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">
              <style>
                @page {size: A4; margin: 15mm; }
                body {font - family: 'Zen Kaku Gothic New', sans-serif; margin: 0; padding: 15mm; width: 100%; box-sizing: border-box; }
                h1 {font - size: 1.4rem; border-bottom: 2px solid #333; padding-bottom: 0.5rem; margin-bottom: 1rem; }
                .page-break {page -break-before: always; height: 0; margin: 0; border: none; }

                ${fractionCss}

        /* Print button styles */
                .print-controls {
                  position: fixed;
                top: 10px;
                right: 10px;
                z-index: 9999;
                display: flex;
                gap: 10px;
        }
                .print-controls button {
                  padding: 10px 20px;
                font-size: 14px;
                cursor: pointer;
                border: none;
                border-radius: 5px;
        }
                .print-btn {background: #4f46e5; color: white; }
                .close-btn {background: #6b7280; color: white; }

                @media print {
          .print - controls {display: none !important; }
                ${customStyles}
        }
                /* Preview styles (non-print) to mimic result */
                ${customStyles}
              </style>
          </head>
          <body>
            <div class="print-controls">
              <button class="print-btn" onclick="window.print()">üñ®Ô∏è Âç∞Âà∑ / PDF‰øùÂ≠ò</button>
              <button class="close-btn" onclick="window.close()">‚úï Èñâ„Åò„Çã</button>
            </div>
            ${headerHtml}
            ${content}
            ${jsScript}
          </body>
        </html>
    `);
  win.document.close();
}

// Wait for DOM
document.addEventListener('DOMContentLoaded', () => {
  try {
    init();
  } catch (e) {
    console.error("Initialization error:", e);
    alert("„Ç¢„Éó„É™„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + e.message);
  }
});
